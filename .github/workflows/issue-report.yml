name: Cloud Status Daily Report

on:
  workflow_run:
    workflows: ["Cloud Service Status Monitor"]
    types: [completed]

permissions:
  issues: write
  contents: read

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set git user from last commit
        run: |
          last_author=$(git --no-pager log --format=format:'%an' -n 1)
          last_email=$(git --no-pager log --format=format:'%ae' -n 1)
          git config user.name "$last_author"
          git config user.email "$last_email"
          echo "Using commit author: $last_author <$last_email>"

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Issue from status file
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Cloud Status Report ${{ steps.date.outputs.date }}"
          content-filepath: data/cloud_status.json
          labels: cloud,status
